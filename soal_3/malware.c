#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <string.h>
#include <time.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <dirent.h>
#include <errno.h>
#include <signal.h>
#include <sys/prctl.h>

#define MAX_MINERS 5

void wannacryptor() {
    prctl(PR_SET_NAME, "wannacryptor");
    while (1) {
        // Implementasi enkripsi XOR dan ZIP
        sleep(30);
    }
}

void trojan_wrm() {
    prctl(PR_SET_NAME, "trojan.wrm");
    while (1) {
        // Menyalin binary ke seluruh direktori di /home
        sleep(30);
    }
}

void miner_loop(int id) {
    char name[32];
    sprintf(name, "mine-crafter-%d", id);
    prctl(PR_SET_NAME, name);

    while (1) {
        // Delay antara 3 - 30 detik
        int delay = 3 + rand() % 28;
        sleep(delay);

        char hash[65];
        for (int i = 0; i < 64; i++) {
            int r = rand() % 16;
            hash[i] = "0123456789abcdef"[r];
        }
        hash[64] = '\0';

        time_t now = time(NULL);
        struct tm *t = localtime(&now);
        char timestamp[64];
        strftime(timestamp, sizeof(timestamp), "%Y-%m-%d %H:%M:%S", t);

        FILE *log = fopen("/tmp/.miner.log", "a");
        if (log) {
            fprintf(log, "[%s][Miner %02d] %s\n", timestamp, id, hash);
            fclose(log);
        }
    }
}

void rodok_exe() {
    prctl(PR_SET_NAME, "rodok.exe");
    for (int i = 0; i < MAX_MINERS; i++) {
        pid_t pid = fork();
        if (pid == 0) {
            miner_loop(i);
            exit(0);
        }
    }
    while (1) pause();
}

void daemonize() {
    pid_t pid = fork();
    if (pid < 0) exit(EXIT_FAILURE);
    if (pid > 0) exit(EXIT_SUCCESS);

    umask(0);
    setsid();
    if (chdir("/")) exit(EXIT_FAILURE);

    close(STDIN_FILENO);
    close(STDOUT_FILENO);
    close(STDERR_FILENO);

    prctl(PR_SET_NAME, "/init");
}

int main() {
    srand(time(NULL));
    daemonize();

    pid_t pid;

    pid = fork();
    if (pid == 0) {
        wannacryptor();
        exit(0);
    }

    pid = fork();
    if (pid == 0) {
        trojan_wrm();
        exit(0);
    }

    pid = fork();
    if (pid == 0) {
        rodok_exe();
        exit(0);
    }

    while (1) pause();
    return 0;
}
